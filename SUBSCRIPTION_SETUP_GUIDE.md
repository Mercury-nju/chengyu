# 订阅收费功能设置指南

## ✅ 代码已完成

订阅系统已完全实现并切换到正式模式：
- ✅ StoreKit 2 集成完成
- ✅ 购买流程实现
- ✅ 恢复购买功能
- ✅ 订阅验证
- ✅ 会员权限检查
- ✅ 默认状态改为非会员

## 📦 产品配置

### 产品 ID（已在代码中定义）

```swift
case monthly = "com.chengyu.anchor.monthly"    // 月度订阅
case yearly = "com.chengyu.anchor.yearly"      // 年度订阅
case lifetime = "com.chengyu.anchor.lifetime"  // 终身购买
```

### 建议定价

| 产品 | 类型 | 建议价格 | 说明 |
|------|------|----------|------|
| 月度订阅 | 自动续订 | ¥18/月 | 适合短期体验用户 |
| 年度订阅 | 自动续订 | ¥128/年 | 相当于 ¥10.67/月，节省 40% |
| 终身购买 | 一次性 | ¥298 | 永久使用，最划算 |

## 🎯 会员权益

### 免费功能
- ✅ 基础冥想功能
- ✅ 触感锚点
- ✅ 心流铸核
- ✅ 情绪光解
- ✅ 基础统计
- ✅ 4 种免费球体材质（default, lava, ice, gold）
- ✅ 8 首免费冥想音乐

### 会员专享
- 🔒 8 首会员专属冥想音乐
- 🔒 3 种高级球体材质（ink, neon, void）
- 🔒 深度解析页面（未来可扩展更多高级分析）
- 🔒 自定义功能（未来扩展）

## 📱 App Store Connect 配置步骤

### 步骤 1: 创建 App 内购买项目

1. 登录 [App Store Connect](https://appstoreconnect.apple.com)
2. 选择你的 App
3. 进入 "功能" → "App 内购买项目"
4. 点击 "+" 创建新的 App 内购买项目

### 步骤 2: 配置月度订阅

1. **类型**：自动续期订阅
2. **参考名称**：锚点 月度会员
3. **产品 ID**：`com.chengyu.anchor.monthly`
4. **订阅群组**：创建新群组 "锚点会员"
5. **订阅时长**：1 个月
6. **价格**：¥18（或你选择的价格）
7. **本地化信息**：
   - 显示名称：月度会员
   - 描述：解锁所有会员专享功能，每月自动续订

### 步骤 3: 配置年度订阅

1. **类型**：自动续期订阅
2. **参考名称**：锚点 年度会员
3. **产品 ID**：`com.chengyu.anchor.yearly`
4. **订阅群组**：选择 "锚点会员"（与月度相同）
5. **订阅时长**：1 年
6. **价格**：¥128
7. **本地化信息**：
   - 显示名称：年度会员
   - 描述：解锁所有会员专享功能，每年自动续订，节省 40%

### 步骤 4: 配置终身购买

1. **类型**：非消耗型项目
2. **参考名称**：锚点 终身会员
3. **产品 ID**：`com.chengyu.anchor.lifetime`
4. **价格**：¥298
5. **本地化信息**：
   - 显示名称：终身会员
   - 描述：一次购买，永久使用所有会员功能

### 步骤 5: 配置订阅群组（重要）

1. 在订阅群组设置中：
   - 群组名称：锚点会员
   - 订阅级别：
     - 月度订阅：级别 1
     - 年度订阅：级别 2（推荐）
2. 这样用户可以在不同订阅之间升级/降级

### 步骤 6: 提交审核

1. 为每个产品添加审核信息
2. 上传审核截图（展示订阅功能）
3. 提交审核

## 🧪 测试

### 沙盒测试账号

1. 在 App Store Connect 中创建沙盒测试账号：
   - 用户和访问 → 沙盒技术测试员
   - 创建新的测试账号

2. 在设备上测试：
   - 设置 → App Store → 沙盒账户
   - 登录测试账号
   - 运行 App 并测试购买

### 测试清单

- [ ] 月度订阅购买
- [ ] 年度订阅购买
- [ ] 终身购买
- [ ] 恢复购买
- [ ] 订阅过期后权限撤销
- [ ] 会员音乐访问控制
- [ ] 球体材质访问控制
- [ ] 订阅升级/降级

## 📄 StoreKit Configuration 文件

项目中已有 `Configuration.storekit` 文件，用于本地测试。

如果需要更新：
1. 在 Xcode 中打开 `Configuration.storekit`
2. 添加/编辑产品
3. 设置测试价格
4. 运行 App 进行本地测试（无需真实购买）

## 🔐 收据验证（可选）

当前使用 StoreKit 2 的本地验证（已足够安全）。

如果需要服务器端验证：
1. 设置后端服务器
2. 实现收据验证 API
3. 在 `SubscriptionManager` 中添加服务器验证逻辑

## 📊 分析和监控

### App Store Connect 数据

可以在 App Store Connect 中查看：
- 订阅数量
- 收入
- 续订率
- 取消率
- 免费试用转化率

### 建议添加的分析

在代码中添加分析事件：
```swift
// 购买成功
Analytics.logEvent("subscription_purchased", parameters: [
    "product_id": productID.rawValue,
    "price": product.price
])

// 订阅取消
Analytics.logEvent("subscription_cancelled", parameters: [
    "product_id": productID.rawValue
])
```

## 💡 优化建议

### 1. 添加免费试用

在 App Store Connect 中为订阅添加免费试用：
- 月度订阅：3 天免费试用
- 年度订阅：7 天免费试用

### 2. 优惠活动

- 首次订阅优惠
- 节假日促销
- 推荐奖励

### 3. 订阅页面优化

当前 `SubscriptionView.swift` 已实现基础 UI，可以进一步优化：
- 添加功能对比表
- 展示用户评价
- 突出最划算的选项
- 添加常见问题解答

### 4. 提醒和通知

- 订阅即将到期提醒
- 续订成功通知
- 特别优惠通知

## 🚀 上线检查清单

### 代码检查
- [x] `isPremium` 默认为 `false`
- [x] `subscriptionType` 默认为 `.none`
- [x] 材质访问控制已启用
- [x] 会员音乐访问控制已启用
- [x] 购买流程完整
- [x] 恢复购买功能正常

### App Store Connect 配置
- [ ] 创建所有产品
- [ ] 设置价格
- [ ] 配置订阅群组
- [ ] 添加本地化信息
- [ ] 提交审核

### 测试
- [ ] 沙盒环境测试通过
- [ ] 所有购买流程正常
- [ ] 权限控制正确
- [ ] 恢复购买正常

### 法律和合规
- [ ] 添加订阅条款
- [ ] 添加隐私政策
- [ ] 添加退款政策
- [ ] 在 App 中显示订阅管理链接

## 📞 技术支持

如果用户遇到订阅问题：
1. 引导用户使用"恢复购买"功能
2. 检查 App Store 账户订阅状态
3. 联系 Apple 支持（订阅由 Apple 管理）

## 🎉 完成！

代码已准备就绪，现在只需要：
1. 在 App Store Connect 中配置产品
2. 使用沙盒账号测试
3. 提交审核
4. 上线收费！

---

**预计收入**（假设）：
- 100 个月度用户：¥1,800/月
- 50 个年度用户：¥6,400/年
- 20 个终身用户：¥5,960（一次性）

**总计**：约 ¥2万+/月（稳定后）
